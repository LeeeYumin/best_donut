<?xml version="1.0" encoding="UTF-8" ?>
 <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.production.mapper.ProdPlanMapper">

<!--생산요청 조회-->
	<select id="getProdReq" resultType="ProdPlanBVO">
		SELECT req_date 
		     , prod_req_code
		     , total_req_cnt
		     , users_code
		FROM prod_req
		WHERE req_date BETWEEN SYSDATE - 8 AND SYSDATE
		AND prod_req_status = 'RS1'
	</select>

<!--생산요청상세 조회-->	
	<select id="getProdReqDetail" resultType="ProdPlanBDeVO">
		SELECT prod_req_code
		     , prd.prod_req_detail_code
		     , prd.product_code
         , p.product_name
		     , prd.req_cnt
		FROM prod_req_detail prd JOIN product p
                              ON prd.product_code = p.product_code
		WHERE prod_req_code = #{prodReqCode}
	</select>
	
	
<!-- 생산계획 조회-->
	<select id="getProdPlan" resultType="ProdPlanVO">
		SELECT prod_plan_code
     		 , prod_req_code
     		 , plan_date
     		 , prod_plan_status
     		 , users_code
		FROM prod_plan
		<include refid="condition"></include>
		ORDER BY plan_date DESC
	</select>

<!-- 동적쿼리(검색) -->
	<sql id="condition">
	<where>
			<if test="searchStartDate != null">
				TRUNC(plan_date) <![CDATA[ >= ]]> TRUNC(#{searchStartDate}) 
			</if>
			<if test="searchEndDate != null">
				AND TRUNC(plan_date) <![CDATA[ <= ]]> TRUNC(#{searchEndDate}) 
			</if>
			<if test="prodPlanCode != null and prodPlanCode != ''">
				AND prod_plan_code LIKE '%' || UPPER(#{prodPlanCode}) || '%'
			</if>
    </where>
	</sql>


<!-- 생산계획상세 조회 -->
	<select id="getProdPlanAll" resultType="ProdPlanAllVO" parameterType="String">
		SELECT d.prod_plan_detail_code
		     , p.prod_plan_code
		     , d.prod_req_detail_code
		     , d.product_code
		     , d.fix_cnt
		     , d.req_cnt
		     , d.plan_cnt
		     , d.not_instruct_cnt
		     , d.instruct_done_cnt
		FROM prod_plan p JOIN prod_plan_detail d
		                    ON p.prod_plan_code = d.prod_plan_code
		WHERE p.prod_plan_code = #{prodPlanCode}
		ORDER BY 1
	</select>

<!-- 생산계획 등록(1건) -->
	<insert id="insertProdPlan" parameterType="ProdPlanVO">
		<selectKey keyProperty="prodPlanCode"
				   order="BEFORE"
				   resultType="String">
		 SELECT seq_func('prod_plan') FROM dual
		</selectKey>
		INSERT INTO prod_plan
			( prod_plan_code
     		 , prod_req_code
     		 , plan_date
     		 , prod_plan_status
     		 , users_code 
     		 )
		VALUES 
			( #{prodPlanCode}
			, #{prodReqCode}
			, #{planDate}
			, 'LS1'
			, #{usersCode}
			)
	</insert>
	<!--생산계획상세 등록(여러 건)  -->
	<insert id="insertProdPlanDetail" parameterType="ProdPlanDeVO">
		INSERT INTO prod_plan_detail
			( PROD_PLAN_DETAIL_CODE
     		 , PROD_PLAN_CODE
     		 , PROD_REQ_DETAIL_CODE
     		 , PRODUCT_CODE
     		 , FIX_CNT
     		 , REQ_CNT
     		 , PLAN_CNT
     		 , NOT_INSTRUCT_CNT
     		 , INSTRUCT_DONE_CNT 
     		 )
		VALUES 
			( seq_func('prod_plan_detail')
			, #{prodPlanCode}
			, #{prodReqDetailCode}
			, #{productCode}
			, #{fixCnt}
			, #{reqCnt}
			, #{fixCnt} + #{reqCnt}
			, #{fixCnt} + #{reqCnt}
			, 0
			)
	</insert>
	<!-- 생산계획등록 시 => 생산요청상태 수정 -->
	<update id="updateProdReqStatus" parameterType="ProdPlanVO">
		UPDATE prod_req
		SET prod_req_status = 'RS2'
		WHERE prod_req_code = #{prodReqCode}
	</update>

	
  	


	
</mapper>