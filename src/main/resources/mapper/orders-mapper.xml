<?xml version="1.0" encoding="UTF-8" ?>
 <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.orders.mapper.OrdersMapper">
	
	<!-- 1. 주문 -->
	
	<!-- 주문목록 조회 -->
	<select id="getOrders1" resultType="Map">
		SELECT o.orders_code
			   , o.orders_date
			   , o.due_date
			   , o.total_orders_price
			   , o.orders_status
			   , c.company_name
			   , u.users_name
		  FROM orders o 
		  JOIN company c ON o.company_code = c.company_code
		  JOIN USERS u   ON o.users_code = u.users_code
		<where>
			<if test="ordersCode != null || ordersCode != ''">
				orders_code LIKE '%' || #{ordersCode} || '%'
			</if>
		</where> 
		 ORDER BY 1
	</select>
	
	<!-- 주문상세목록 조회 -->
	<select id="getOrdersDetail" resultType="OrdersDetailVO" parameterType="String">
		SELECT d.orders_detail_code
		       , d.orders_cnt
			   , d.supply_price
			   , d.tax
			   , d.total_supply_price
			   , d.orders_code
			   , d.product_code
			   , p.product_name
		  FROM orders_detail d JOIN product p
		    ON d.product_code = p.product_code
		 WHERE d.orders_code = #{ordersCode}
		 ORDER BY 1
	</select>
	
	<!-- 주문 등록 -->
	<insert id="insertOrders" parameterType="OrdersVO">
		<!--
		selectKey : insert하고 난 후 자동 생성된 key값 받아서
					다른 insert문에 바로 사용
		 -->
		<selectKey keyProperty="ordersCode" order="BEFORE" resultType="String">
		 	SELECT seq_func('orders') FROM dual
		</selectKey>		
		INSERT INTO orders
			(
				orders_code
				, orders_date
				, due_date
				, total_orders_price
				, orders_status
				, users_code
				, company_code
			)
		VALUES 
			(
				 #{ordersCode}
				, #{ordersDate}
				, #{dueDate}
				, #{totalOrdersPrice}
				, 'OP1'
				, 'USE00002'
				, #{companyCode}
			)
	</insert>
	
	<!-- 주문상세 등록 -->
	<insert id="insertOrdDet" parameterType="OrdersDetailVO">	
		INSERT INTO orders_detail
			(
				orders_detail_code
				, orders_cnt
				, supply_price
				, tax
				, total_supply_price
				, orders_code
				, product_code
			)
		VALUES
			(
				seq_func('orders_detail')
				, #{ordersCnt}
				, #{supplyPrice}
				, #{tax}
				, #{totalSupplyPrice}
				, #{ordersCode}
				, #{productCode}
			)
	</insert>
	
	
	<!-- 2. 생산요청 -->
	
	<!-- 주문조회 -->
	<select id="getOrders" resultType="Map">
		WITH tables AS 
			(
			SELECT o.orders_code         AS o_code
			       , MAX(p.product_name) AS p_name
			       , COUNT(*)            AS cnt
			  FROM orders o JOIN orders_detail d
			                  ON o.orders_code = d.orders_code
			                JOIN product p
			                  ON d.product_code = p.product_code
			GROUP BY o.orders_code
			)
		SELECT o.orders_code AS "ordersCode"
		       , o.orders_date AS "ordersDate"
		       , o.due_date AS "dueDate"
		       , o.total_orders_price AS "totalOrdersPrice"
		       , o.orders_status AS "ordersStatus"
		       , c.company_name AS "companyName"
		       , u.users_name AS "usersName"
		       , CASE WHEN t.cnt = 1 THEN t.p_name
		              ELSE t.p_name || ' 외 ' || CAST(t.cnt - 1 AS VARCHAR(20)) || '건' 
		         END AS "cntStr"
		  FROM orders o 
		  JOIN company c       ON o.company_code = c.company_code
		  JOIN users u         ON o.users_code = u.users_code
		  JOIN orders_detail d ON o.orders_code = d.orders_code
		  JOIN tables t        ON o.orders_code = t.o_code
		 GROUP BY o.orders_code
		          , o.orders_date
		          , o.due_date
		          , o.total_orders_price
		          , o.orders_status
		          , c.company_name
		          , u.users_name
		          , CASE WHEN t.cnt = 1 THEN t.p_name ELSE t.p_name || ' 외 ' || CAST(t.cnt - 1 AS VARCHAR(20)) || '건' END
		ORDER BY 1
		 
	</select>
	
	<!-- 생산요청 등록 -->
	<insert id="insertProdReq" parameterType="ProdReqVO">
		<selectKey keyProperty="prodReqCode" order="BEFORE" resultType="String">
			SELECT seq_func('prod_req') FROM dual
		</selectKey>
	  	INSERT INTO prod_req
			(
				prod_eqCode
				, totalReqCnt
				, reqDate
				, usersCode
				, prodReqStatus
			)
		VALUES
			(
				#{prodReqCode}
				, totalReqCnt
				, reqDate
				, usersCode
				, prodReqStatus
			)
	</insert>
</mapper>